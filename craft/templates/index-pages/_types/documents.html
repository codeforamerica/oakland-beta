{% extends '_base.html' %}

{% block page_styles %}
<link rel="stylesheet" href="{{ craft.config.rootUrl }}resources/css/jquery-ui.structure.min.css">
{% endblock %}

{% block page_scripts %}
{# Build Filter Box #}
<script src="{{ craft.config.rootUrl }}/resources/js/filterbox.js"></script>
{# Instantiate Datepicker #}
<script src="{{ craft.config.rootUrl }}/resources/js/jquery-ui.min.js"></script>
<script>
  $('.datepicker').datepicker({
    "prevText": "",
    "nextText": "",
    "dateFormat": "yy-mm-dd"
  });
</script>
{% endblock %}

{% block content %}

{# Instantiate Filters #}
{% set keywords = "" %}
{% set document_types = ['or'] %}
{% set departments_initiatives = ['or'] %}
{% set document_type_slugs = [] %}
{% set department_slugs = [] %}
{% set initiative_slugs = [] %}
{% set published_after = craft.request.getQuery('published-after') %}
{% set published_before = craft.request.getQuery('published-before') %}
{% set dateParams = ['and'] %}
{% set relatedEntry = null %}
{% set relatedToParams = ['and'] %}

{# If Related To having been selected (e.g., seeing all of an departments news) #}
{% if craft.request.getParam('q') %}
  {% set query = craft.request.getParam('q') %}
  {% set relatedEntry = craft.entries.slug(query).first() %}
  {% set documentEntries = craft.entries.section('documents').relatedTo(relatedEntry) %}
{% endif %}

{# If keywords are specified #}
{% if craft.request.getQuery('keywords') %}
  {% set keywords = craft.request.getQuery('keywords') %}
{% endif %}

{# If News Types are specififed #}
{% if craft.request.getQuery('document-types') | length > 0 %}
  {% set document_type_slugs = craft.request.getQuery('document-types') %}
  {% for type in document_type_slugs %}
    {% set document_types = document_types | merge([craft.categories.slug(type)]) %}
  {% endfor %}

  {% set relatedToParams = relatedToParams | merge([{targetElement: document_types}]) %}
{% endif %}

{# If publish dates are specified #}
{% if published_after != "" %}
  {% set dateParams = dateParams | merge(['>=' ~ published_after]) %}
{% endif %}

{% if published_before != "" %}
  {% set dateParams = dateParams | merge(['<=' ~ published_before]) %}
{% endif %}

{# If departments are specificed #}
{% if craft.request.getQuery('departments') %}
{% set department_slugs = craft.request.getQuery('departments') %}
  {% for department in department_slugs %}
    {% set departments_initiatives = departments_initiatives | merge([craft.entries.slug(department)]) %}
  {% endfor %}
{% endif %}

{# If initiatives are specificed #}
{% if craft.request.getQuery('initiatives') %}
  {% set initiative_slugs = craft.request.getQuery('initiatives') %}
  {% for initiative in initiative_slugs %}
    {% set departments_initiatives = departments_initiatives | merge([craft.entries.slug(initiative)]) %}
  {% endfor %}
{% endif %}

{% if departments_initiatives | length > 1 %}
  {% set relatedToParams = relatedToParams | merge([{targetElement: departments_initiatives}]) %}
{% endif %}


{# Avoid passing an array with `['and']` only #}
{% if relatedToParams | length < 2 %}
  {% set relatedToParams = "" %}
{% endif %}

{% if dateParams | length < 2 %}
  {% set dateParams = "" %}
{% endif %}

{# Build the ridiculously complicated search query #}
{% set documentEntries = craft.entries({
  section: "documents",
  search: keywords,
  documentPublishDate: dateParams,
  relatedTo: relatedToParams
}) %}

<main class="documents-index">

  <div class="main-overlay"></div>

  <section class="subheader">
    <div class="breadcrumb-wrap">
      <nav class="breadcrumbs">
        <a href="{{ siteUrl }}">{{"Oakland" | translate }}</a>
        <span>{% if relatedEntry %}{{ relatedEntry.title }} | {% endif %}{{"Documents" | translate }}</span>
      </nav>
    </div>
    <div class="container">
      <div class="grid-row">
        <div class="two-thirds section-info">
          <h1>{% if relatedEntry %}{{ relatedEntry.title }} | {% endif %}{{"Documents" | translate }}</h1>
          <p>Search public records, reports, policies, ordiances, forms, and more.</p>
        </div>
      </div>
      
    </div>
  </section>

  <form class="filterbox" action="{{siteUrl}}documents">
    <div class="container">
      <div class="grid-row">
        <div class="one-whole">
          <p>Search by Keyword</p>
          <div class="filterbox-search">
            <input class="filterbox-search-input" name="keywords" value="{{keywords}}" />
            <button type="submit" class="btn btn-small filterbox-search-button">Search <span class="lnr lnr-small lnr-arrow-right"></span></button>
          </div>
        </div>
      </div>
      <hr>
      <div class="filterbox-filters grid-row">
        <div class="filterbox-filter one-fourth">
          <p class="filterbox-filter-label">Document Type <span class="lnr lnr-small lnr-chevron-down"></span></p>
          <p class="filterbox-filter-selection">{% if document_type_slugs | length > 0 %}{{ document_type_slugs | length }} type(s) selected{% endif %}</p>
          <div class="filterbox-drawer">
            <ul class="list-no-style">
              {% for type in craft.categories.group('documentTypes') %}
                <li><label for="{{ type.slug }}"><input type="checkbox" name="document-types[]" value="{{ type.slug}}" id="{{type.slug}}" {% if type.slug in document_type_slugs %}checked{% endif %}>{{type.title}}</label></li>
              {% endfor %}
            </ul>

          </div>
        </div>
        <div class="filterbox-filter one-fourth">
          <p class="filterbox-filter-label">Publish Date <span class="lnr lnr-small lnr-chevron-down"></span></p>
          <p class="filterbox-filter-selection">{% if published_after %}{{published_after|date('M d, Y')}}{% endif %}{% if published_before %} - {{ published_before|date('M d, Y')}}{% endif %}</p>
          <div class="filterbox-drawer">
            <ul class="list-no-style">
              <li>
                <p>No Earlier Than</p>
                <input type="text" class="datepicker" name="published-after" id="published-after" value="{{ published_after }}">
              </li>
              <li>
                <p>No Later Than</p>
                <input type="text" class="datepicker" name="published-before" id="published-before" value="{{ published_before }}">
              </li>
            </ul>
          </div>
        </div>
        <div class="filterbox-filter one-fourth">
          <p class="filterbox-filter-label">Department / Initiative <span class="lnr lnr-small lnr-chevron-down"></span></p>
          <p class="filterbox-filter-selection">{% if departments_initiatives | length > 1 %}{{departments_initiatives | length - 1}} type(s) selected{% endif %}</p>
          <div class="filterbox-drawer">
            <h6>Initiative</h6>
            <ul class="list-no-style">
              {% for initiative in craft.entries.section('initiatives') %}
              <li><label for="{{ initiative.slug }}"><input type="checkbox" name="initiatives[]" value="{{ initiative.slug}}" id="{{initiative.slug}}" {% if initiative.slug in initiative_slugs %}checked{% endif %}>{{initiative.title}}</label></li>
              {% endfor %}
            </ul>
            <h6>Departments</h6>
            <ul class="list-no-style">
              {% for department in craft.entries.section('departments') %}
              <li><label for="{{ department.slug }}"><input type="checkbox" name="departments[]" value="{{ department.slug}}" id="{{department.slug}}" {% if department.slug in department_slugs %}checked{% endif %}>{{department.title}}</label></li>
              {% endfor %}
            </ul>
          </div>
        </div>
        <div class="filterbox-filter one-fourth column-last">
          <a href="{{siteUrl}}documents" class="text-small right">Reset Search</a>
          
        </div>
      </div>
     </div>
  </form>

  <section>
    <div class="container">
      {% if documentEntries | length > 0 %}
      {% paginate documentEntries.limit(2) as pageInfo, pageEntries %}
      {% for document in pageEntries %} 

      <div class="post-excerpt grid-row">
        <div class="one-whole">
          <p class="post-data"><time datetime="">{{ document.documentPublishDate.localeDate() | date('l, M d, Y') }}</time> | {{ document.documentType.first().title }}</p>
          <h3><a href="{{ document.url }}">{{ document.title }}</a></h3> 
          <p>{{ document.documentDescriptionSummary }}</p>
        </div>
      </div>
      <hr>
      {% endfor %}

      {% if pageInfo.totalPages > 1 %}
      <div class="pagination">
        <a class="pagination-link" href="{{ pageInfo.firstUrl }}">First</a>
        {% if pageInfo.prevUrl %}<a class="pagination-link" href="{{ pageInfo.prevUrl }}?{{ craft.request.getQueryStringWithoutPath() }}">Previous</a>{% endif %}

        {% for page, url in pageInfo.getPrevUrls(5) %}
            <a class="pagination-link" href="{{ url }}?{{ craft.request.getQueryStringWithoutPath() }}">{{ page }}</a>
        {% endfor %}

        <span class="pagination-current">{{ pageInfo.currentPage }}</span>

        {% for page, url in pageInfo.getNextUrls(5) %}
            <a class="pagination-link" href="{{ url }}?{{ craft.request.getQueryStringWithoutPath() }}">{{ page }}</a>
        {% endfor %}

        {% if pageInfo.nextUrl %}<a class="pagination-link" href="{{ pageInfo.nextUrl }}?{{ craft.request.getQueryStringWithoutPath() }}">Next</a>{% endif %}
        <a class="pagination-link" href="{{ pageInfo.lastUrl }}?{{ craft.request.getQueryStringWithoutPath() }}">Last</a>
      </div>
      {% endif %}

      {% else %}
      <h2>No Results Found</h2>
      {% endif %}
    </div>
  </section>

</main> 
{% endblock %}   